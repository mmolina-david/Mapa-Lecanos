<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa prueba - MapLibre</title>

  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }

    /* =========================
       Contenedor Leyenda + Barra año (horizontal)
       ========================= */
    #legendWrap {
      position: absolute;
      bottom: 30px;
      left: 30px;
      z-index: 10;
      font-family: sans-serif;
      user-select: none;
      width: 260px; /* ancho base (barra año encaja) */
    }

    /* =========================
       Leyenda + filtros
       ========================= */
    #legend {
      background: rgba(255, 255, 255, 0.92);
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 13px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      min-width: 260px;
    }
    .legend-title {
      font-weight: bold;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .legend-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border: 1px solid #333;
      border-radius: 3px;
      flex: 0 0 14px;
    }
    .legend-actions button {
      font-size: 12px;
      padding: 2px 6px;
      cursor: pointer;
    }
    .legend-item input[type="checkbox"] {
      transform: scale(1.05);
      cursor: pointer;
    }

    /* =========================
       Barra año (horizontal, debajo y mismo ancho que la leyenda)
       ========================= */
    #yearBar {
      margin-top: 8px;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      padding: 10px 12px;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #yearLabel {
      font-weight: 700;
      font-size: 13px;
      width: 52px;
      text-align: left;
      flex: 0 0 52px;
    }
    #yearSlider {
      width: 100%;
      cursor: pointer;
    }
    #yearHint {
      font-size: 12px;
      opacity: 0.75;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    /* =========================
       Selector de orto (pegado arriba de legendWrap con JS)
       ========================= */
    #basemapControl {
      position: absolute;
      left: 30px;
      z-index: 11;
      font-family: sans-serif;
      user-select: none;
    }

    .bm-wrap {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      overflow: hidden;
      min-width: 260px; /* igual que leyenda */
    }

    .bm-button {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 0;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      line-height: 1;
    }

    .bm-logo {
      width: 28px;
      height: 28px;
      object-fit: contain;
      flex: 0 0 28px;
    }

    .bm-current {
      display: flex;
      flex-direction: column;
      gap: 3px;
      align-items: flex-start;
      flex: 1;
      min-width: 0;
    }

    .bm-current .bm-label {
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bm-current .bm-sub {
      font-size: 12px;
      opacity: 0.75;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bm-caret {
      font-size: 14px;
      opacity: 0.8;
    }

    .bm-panel {
      display: none;
      border-top: 1px solid rgba(0,0,0,0.08);
      padding: 10px 10px 8px 10px;
      background: rgba(255, 255, 255, 0.98);
    }
    .bm-panel.open { display: block; }

    .bm-title {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .bm-options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      max-height: 220px;
      overflow: auto;
      padding-right: 2px;
    }

    .bm-option {
      width: 100%;
      text-align: left;
      padding: 7px 8px;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.10);
      background: white;
      cursor: pointer;
      font-size: 13px;
    }
    .bm-option:hover { background: rgba(0,0,0,0.04); }
    .bm-option.active {
      border-color: rgba(0,0,0,0.35);
      font-weight: 700;
    }

    /* =========================
       Popup inicial (modal discreta)
       ========================= */
    #introModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 18px;
    }
    #introCard {
      width: min(520px, 92vw);
      background: rgba(255,255,255,0.96);
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      padding: 16px 16px 14px 16px;
      font-family: sans-serif;
    }
    #introTitle {
      font-weight: 800;
      margin: 0 0 8px 0;
      font-size: 14px;
    }
    #introText {
      margin: 0 0 12px 0;
      font-size: 13px;
      line-height: 1.35;
      opacity: 0.92;
    }
    #introActions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .btn {
      border: 0;
      border-radius: 8px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 13px;
    }
    .btn-primary {
      background: rgba(0,0,0,0.85);
      color: white;
    }

    /* =========================
       Controles MapLibre (zoom + escala) discretos
       ========================= */
    .maplibregl-ctrl-top-right { top: 12px; right: 12px; }
    .maplibregl-ctrl-group {
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      border-radius: 8px !important;
      overflow: hidden;
      opacity: 0.85;
    }
    .maplibregl-ctrl-scale {
      background: rgba(255,255,255,0.92) !important;
      border: 0 !important;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 6px 8px !important;
      opacity: 0.85;
      font-family: sans-serif;
      font-size: 12px !important;
      margin-top: 8px !important;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Modal inicial -->
  <div id="introModal" role="dialog" aria-modal="true" aria-label="Aviso de versión">
    <div id="introCard">
      <div id="introTitle">Aviso</div>
      <p id="introText">Esta es una versión de prueba, en fase de desarrollo, los datos que aparecen no son reales.</p>
      <div id="introActions">
        <button id="introClose" class="btn btn-primary" type="button">Entendido</button>
      </div>
    </div>
  </div>

  <!-- Selector de ortofoto (pegado arriba de la leyenda con JS) -->
  <div id="basemapControl">
    <div class="bm-wrap">
      <button id="bmBtn" class="bm-button" type="button" aria-haspopup="listbox" aria-expanded="false">
        <img id="bmLogo" class="bm-logo" alt="geoEuskadi" />
        <div class="bm-current">
          <div id="bmYearLabel" class="bm-label">2018</div>
          <div class="bm-sub">Ortofoto (RGB)</div>
        </div>
        <div class="bm-caret">▾</div>
      </button>

      <div id="bmPanel" class="bm-panel" role="listbox" aria-label="Selector de ortofoto">
        <div class="bm-title">Fuente: Eusko Jaurlaritza / Gobierno Vasco. geoEuskadi</div>
        <div id="bmOptions" class="bm-options"></div>
      </div>
    </div>
  </div>

  <!-- Leyenda + barra año (horizontal) -->
  <div id="legendWrap">
    <div id="legend">
      <div class="legend-title">
        <span>Nivel de afección</span>
        <span class="legend-actions">
          <button id="allBtn" type="button">Todas</button>
          <button id="noneBtn" type="button">Ninguna</button>
        </span>
      </div>

      <label class="legend-item">
        <span class="legend-left">
          <span class="legend-color" style="background:#a6d96a;"></span>
          <span>Sano (0%)</span>
        </span>
        <input type="checkbox" class="class-toggle" value="0" checked />
      </label>

      <label class="legend-item">
        <span class="legend-left">
          <span class="legend-color" style="background:#ffffc0;"></span>
          <span>Leve (&lt;20%)</span>
        </span>
        <input type="checkbox" class="class-toggle" value="1" checked />
      </label>

      <label class="legend-item">
        <span class="legend-left">
          <span class="legend-color" style="background:#fdae61;"></span>
          <span>Moderado (20-60%)</span>
        </span>
        <input type="checkbox" class="class-toggle" value="2" checked />
      </label>

      <label class="legend-item" style="margin-bottom:0;">
        <span class="legend-left">
          <span class="legend-color" style="background:#d7191c;"></span>
          <span>Grave (&gt;60%)</span>
        </span>
        <input type="checkbox" class="class-toggle" value="3" checked />
      </label>
    </div>

    <div id="yearBar">
      <div id="yearLabel">2018</div>
      <input id="yearSlider" type="range" min="0" max="0" step="1" value="0" />
      <div id="yearHint">Año MFV</div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG GENERAL
    // =========================
    const LOGO_URL = './data/geoeuskadi.png';

    // Años temáticos (campos y_YYYY dentro del GeoJSON)
    const YEARS = [2018, 2019, 2020, 2021, 2022, 2023, 2024];
    const DEFAULT_YEAR = 2018;
    const YEAR_FIELD_PREFIX = 'y_';

    // ÚNICA capa: zoomout (tu simplificado)
    const MFV_ZOOMOUT_URL = './data/mfv_zoomout.geojson';

    // Colores por clase (0-3)
    const CLASS_COLORS = { 0:'#a6d96a', 1:'#ffffc0', 2:'#fdae61', 3:'#d7191c' };

    // A partir de este zoom, el relleno se va vaciando (pero no desaparece la capa)
    const FILL_FADE_START = 12;
    const FILL_FADE_END   = 15;

    // =========================
    // CONFIG WMS geoEuskadi (RGB)
    // =========================
    const ORTO_YEARS = [
      2024, 2023, 2022, 2021, 2020, 2019, 2018,
      2017, 2016, 2015, 2014, 2013, 2012, 2011,
      2010, 2009, 2008, 2007, 2006, 2005, 2004,
      2002, 2001, 1995, 1991, 1989, 1984
    ];

    function wmsTileUrlForYear(year) {
      return "https://www.geo.euskadi.eus/WMS_ORTOARGAZKIAK" +
        "?service=WMS&request=GetMap&version=1.3.0" +
        "&layers=ORTO_" + year +
        "&styles=default" +
        "&format=image/png" +
        "&transparent=false" +
        "&CRS=EPSG:3857" +
        "&BBOX={bbox-epsg-3857}" +
        "&WIDTH=256&HEIGHT=256";
    }

    // =========================
    // HELPERS (bounds polígonos)
    // =========================
    function extendBoundsFromCoords(bounds, coords) {
      if (!Array.isArray(coords) || coords.length === 0) return;
      if (typeof coords[0] === 'number' && typeof coords[1] === 'number') {
        bounds.extend([coords[0], coords[1]]);
        return;
      }
      coords.forEach(c => extendBoundsFromCoords(bounds, c));
    }

    function fitToGeoJSON(map, geojson) {
      const bounds = new maplibregl.LngLatBounds();
      let any = false;

      (geojson.features || []).forEach(f => {
        if (!f || !f.geometry || !f.geometry.coordinates) return;
        extendBoundsFromCoords(bounds, f.geometry.coordinates);
        any = true;
      });

      if (any) map.fitBounds(bounds, { padding: 40, maxZoom: 16 });
    }

    // =========================
    // EXPRESIONES (color + opacidad)
    // =========================
    function activeFieldForYear(year) {
      return `${YEAR_FIELD_PREFIX}${year}`; // y_2018...
    }

    function classColorExpression(fieldName) {
      return [
        'match',
        ['to-number', ['get', fieldName]],
        0, CLASS_COLORS[0],
        1, CLASS_COLORS[1],
        2, CLASS_COLORS[2],
        3, CLASS_COLORS[3],
        'rgba(0,0,0,0)'
      ];
    }

    function fillOpacityByZoom() {
      return [
        'interpolate', ['linear'], ['zoom'],
        0, 0.70,
        FILL_FADE_START, 0.70,
        FILL_FADE_END, 0.00
      ];
    }

    // =========================
    // MAPA (WMS 2018 por defecto)
    // =========================
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          satellite: {
            type: 'raster',
            tiles: [ wmsTileUrlForYear(DEFAULT_YEAR) ],
            tileSize: 256
          }
        },
        layers: [
          { id: 'satellite', type: 'raster', source: 'satellite' }
        ]
      },
      center: [0, 0],
      zoom: 2
    });

    // Controles discretos: zoom + escala
    map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-right');
    map.addControl(new maplibregl.ScaleControl({ maxWidth: 120, unit: 'metric' }), 'top-right');

    // =========================
    // Modal inicial
    // =========================
    const introModal = document.getElementById('introModal');
    const introClose = document.getElementById('introClose');
    introClose.addEventListener('click', () => introModal.style.display = 'none');
    introModal.addEventListener('click', (e) => { if (e.target === introModal) introModal.style.display = 'none'; });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') introModal.style.display = 'none'; });

    // =========================
    // UI: selector WMS
    // =========================
    const bmBtn = document.getElementById('bmBtn');
    const bmPanel = document.getElementById('bmPanel');
    const bmOptions = document.getElementById('bmOptions');
    const bmYearLabel = document.getElementById('bmYearLabel');
    const bmLogo = document.getElementById('bmLogo');
    bmLogo.src = LOGO_URL;

    let selectedOrtoYear = DEFAULT_YEAR;
    bmYearLabel.textContent = String(selectedOrtoYear);

    function updateBasemapUI(year) {
      bmYearLabel.textContent = String(year);
      Array.from(bmOptions.querySelectorAll('.bm-option')).forEach(btn => {
        btn.classList.toggle('active', Number(btn.dataset.year) === year);
      });
    }

    function ensureBasemapBelow() {
      const mfvFill = map.getLayer('mfv-fill') ? 'mfv-fill' : null;
      if (mfvFill && map.getLayer('satellite')) {
        try { map.moveLayer('satellite', mfvFill); } catch (_) {}
      }
    }

    function setBasemapYear(year) {
      selectedOrtoYear = year;
      updateBasemapUI(year);

      const tiles = [ wmsTileUrlForYear(year) ];
      const src = map.getSource('satellite');

      if (src && typeof src.setTiles === 'function') {
        src.setTiles(tiles);
        ensureBasemapBelow();
        return;
      }

      if (map.getLayer('satellite')) map.removeLayer('satellite');
      if (map.getSource('satellite')) map.removeSource('satellite');

      map.addSource('satellite', { type: 'raster', tiles, tileSize: 256 });

      if (map.getLayer('mfv-fill')) {
        map.addLayer({ id: 'satellite', type: 'raster', source: 'satellite' }, 'mfv-fill');
      } else {
        map.addLayer({ id: 'satellite', type: 'raster', source: 'satellite' });
      }
    }

    function renderBasemapOptions() {
      bmOptions.innerHTML = '';
      ORTO_YEARS.forEach(y => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'bm-option' + (y === selectedOrtoYear ? ' active' : '');
        btn.textContent = String(y);
        btn.dataset.year = String(y);
        btn.addEventListener('click', () => {
          setBasemapYear(y);
          closeBasemapPanel();
        });
        bmOptions.appendChild(btn);
      });
    }

    function openBasemapPanel() {
      bmPanel.classList.add('open');
      bmBtn.setAttribute('aria-expanded', 'true');
      setTimeout(() => stickBasemapAboveLegend(10), 0);
    }
    function closeBasemapPanel() {
      bmPanel.classList.remove('open');
      bmBtn.setAttribute('aria-expanded', 'false');
      setTimeout(() => stickBasemapAboveLegend(10), 0);
    }
    function toggleBasemapPanel() {
      if (bmPanel.classList.contains('open')) closeBasemapPanel();
      else openBasemapPanel();
    }

    bmBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleBasemapPanel(); });
    document.addEventListener('click', () => closeBasemapPanel());
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeBasemapPanel(); });

    renderBasemapOptions();
    updateBasemapUI(DEFAULT_YEAR);

    // =========================
    // “Pegado” del desplegable sobre la leyenda
    // =========================
    function stickBasemapAboveLegend(gapPx = 10) {
      const anchor = document.getElementById('legendWrap');
      const basemap = document.getElementById('basemapControl');
      if (!anchor || !basemap) return;

      const rect = anchor.getBoundingClientRect();
      const viewportH = window.innerHeight;

      const bottomFromBottom = viewportH - rect.bottom;
      basemap.style.bottom = `${bottomFromBottom + rect.height + gapPx}px`;
    }
    window.addEventListener('resize', () => stickBasemapAboveLegend(10));

    // =========================
    // UI: barra año (horizontal)
    // =========================
    const yearSlider = document.getElementById('yearSlider');
    const yearLabel  = document.getElementById('yearLabel');

    function yearFromIndex(i) {
      const idx = Math.max(0, Math.min(YEARS.length - 1, Number(i)));
      return YEARS[idx];
    }

    let activeYear = DEFAULT_YEAR;

    function initYearSlider() {
      yearSlider.min = 0;
      yearSlider.max = String(YEARS.length - 1);
      yearSlider.step = 1;
      yearSlider.value = String(Math.max(0, YEARS.indexOf(DEFAULT_YEAR)));
      activeYear = yearFromIndex(yearSlider.value);
      yearLabel.textContent = String(activeYear);
    }

    // =========================
    // Leyenda (checkboxes) + filtros
    // =========================
    function selectedClasses() {
      const toggles = Array.from(document.querySelectorAll('.class-toggle'));
      return toggles.filter(cb => cb.checked).map(cb => Number(cb.value));
    }

    function applyClassFilterForYear(year) {
      const fieldName = activeFieldForYear(year);
      const selected = selectedClasses();

      const hide = (selected.length === 0);
      const filter = hide ? null : ['in', ['to-number', ['get', fieldName]], ['literal', selected]];

      ['mfv-fill', 'mfv-line'].forEach(layerId => {
        if (!map.getLayer(layerId)) return;

        if (hide) {
          map.setLayoutProperty(layerId, 'visibility', 'none');
        } else {
          map.setLayoutProperty(layerId, 'visibility', 'visible');
          map.setFilter(layerId, filter);
        }
      });
    }

    function applyYearStyle(year) {
      const fieldName = activeFieldForYear(year);
      yearLabel.textContent = String(year);

      // Relleno por clase + se vacía con zoom
      if (map.getLayer('mfv-fill')) {
        map.setPaintProperty('mfv-fill', 'fill-color', classColorExpression(fieldName));
        map.setPaintProperty('mfv-fill', 'fill-opacity', fillOpacityByZoom());
      }

      // Bordes: mismo color por clase, siempre visibles
      if (map.getLayer('mfv-line')) {
        map.setPaintProperty('mfv-line', 'line-color', classColorExpression(fieldName));
      }

      applyClassFilterForYear(year);
      ensureBasemapBelow();
    }

    function initLegendHandlers() {
      const toggles = Array.from(document.querySelectorAll('.class-toggle'));
      const allBtn = document.getElementById('allBtn');
      const noneBtn = document.getElementById('noneBtn');

      function apply() { applyClassFilterForYear(activeYear); }

      toggles.forEach(cb => cb.addEventListener('change', apply));
      allBtn.addEventListener('click', () => { toggles.forEach(cb => cb.checked = true); apply(); });
      noneBtn.addEventListener('click', () => { toggles.forEach(cb => cb.checked = false); apply(); });
    }

    // =========================
    // CARGA: fuente MFV zoomout + capas (polígonos)
    // =========================
    map.on('load', async () => {
      initYearSlider();
      initLegendHandlers();
      stickBasemapAboveLegend(10);

      yearSlider.addEventListener('input', () => {
        activeYear = yearFromIndex(yearSlider.value);
        applyYearStyle(activeYear);
      });

      // Fuente (zoomout)
      map.addSource('mfv', { type: 'geojson', data: MFV_ZOOMOUT_URL });

      // Fill (no desaparece, se vacía con el zoom)
      map.addLayer({
        id: 'mfv-fill',
        type: 'fill',
        source: 'mfv',
        paint: {
          'fill-color': classColorExpression(activeFieldForYear(activeYear)),
          'fill-opacity': fillOpacityByZoom()
        }
      });

      // Bordes (mismo color por clase)
      map.addLayer({
        id: 'mfv-line',
        type: 'line',
        source: 'mfv',
        paint: {
          'line-color': classColorExpression(activeFieldForYear(activeYear)),
          'line-width': [
            'interpolate', ['linear'], ['zoom'],
            8, 0.6,
            12, 1.0,
            15, 1.6,
            17, 2.2
          ],
          'line-opacity': 0.95
        }
      });

      ensureBasemapBelow();
      applyYearStyle(activeYear);

      // Zoom a la capa (fit)
      try {
        const r = await fetch(MFV_ZOOMOUT_URL);
        if (r.ok) {
          const gj = await r.json();
          fitToGeoJSON(map, gj);
        }
      } catch (_) {}

      setTimeout(() => stickBasemapAboveLegend(10), 0);
    });
  </script>
</body>
</html>



