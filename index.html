<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa prueba - MapLibre</title>

  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }

    /* Leyenda + filtros */
    #legend {
      position: absolute;
      bottom: 30px;
      left: 30px;
      background: rgba(255, 255, 255, 0.92);
      padding: 10px 12px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 13px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      min-width: 170px;
      user-select: none;
      z-index: 10;
    }
    .legend-title {
      font-weight: bold;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .legend-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border: 1px solid #333;
      border-radius: 3px;
      flex: 0 0 14px;
    }
    .legend-actions button {
      font-size: 12px;
      padding: 2px 6px;
      cursor: pointer;
    }
    .legend-item input[type="checkbox"] {
      transform: scale(1.05);
      cursor: pointer;
    }

    /* =========================
       Selector de orto (encima de la leyenda)
       ========================= */
    #basemapControl {
      position: absolute;
      bottom: 210px; /* encima del #legend */
      left: 30px;
      z-index: 11;
      font-family: sans-serif;
      user-select: none;
    }

    .bm-wrap {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      overflow: hidden;
      min-width: 240px;
    }

    .bm-button {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 0;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      line-height: 1;
    }

    .bm-logo {
      width: 28px;
      height: 28px;
      object-fit: contain;
      flex: 0 0 28px;
    }

    .bm-current {
      display: flex;
      flex-direction: column;
      gap: 3px;
      align-items: flex-start;
      flex: 1;
      min-width: 0;
    }

    .bm-current .bm-label {
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .bm-current .bm-sub {
      font-size: 12px;
      opacity: 0.75;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bm-caret {
      font-size: 14px;
      opacity: 0.8;
    }

    .bm-panel {
      display: none;
      border-top: 1px solid rgba(0,0,0,0.08);
      padding: 10px 10px 8px 10px;
      background: rgba(255, 255, 255, 0.98);
    }
    .bm-panel.open { display: block; }

    .bm-title {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .bm-options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      max-height: 220px;
      overflow: auto;
      padding-right: 2px;
    }

    .bm-option {
      width: 100%;
      text-align: left;
      padding: 7px 8px;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.10);
      background: white;
      cursor: pointer;
      font-size: 13px;
    }
    .bm-option:hover {
      background: rgba(0,0,0,0.04);
    }
    .bm-option.active {
      border-color: rgba(0,0,0,0.35);
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Selector de ortofoto (encima de la leyenda) -->
  <div id="basemapControl">
    <div class="bm-wrap">
      <button id="bmBtn" class="bm-button" type="button" aria-haspopup="listbox" aria-expanded="false">
        <img id="bmLogo" class="bm-logo" alt="geoEuskadi" />
        <div class="bm-current">
          <div id="bmYearLabel" class="bm-label">2018</div>
          <div class="bm-sub">Ortofoto (RGB)</div>
        </div>
        <div class="bm-caret">▾</div>
      </button>

      <div id="bmPanel" class="bm-panel" role="listbox" aria-label="Selector de ortofoto">
        <div class="bm-title">Fuente: Eusko Jaurlaritza / Gobierno Vasco. geoEuskadi</div>
        <div id="bmOptions" class="bm-options"></div>
      </div>
    </div>
  </div>

  <!-- Leyenda con selección de clases -->
  <div id="legend">
    <div class="legend-title">
      <span>Nivel de afección</span>
      <span class="legend-actions">
        <button id="allBtn" type="button">Todas</button>
        <button id="noneBtn" type="button">Ninguna</button>
      </span>
    </div>

    <label class="legend-item">
      <span class="legend-left">
        <span class="legend-color" style="background:#a6d96a;"></span>
        <span>&quot;Sano (0%)&quot;</span>
      </span>
      <input type="checkbox" class="class-toggle" value="0" checked />
    </label>

    <label class="legend-item">
      <span class="legend-left">
        <span class="legend-color" style="background:#ffffc0;"></span>
        <span>&quot;Leve (<20%)&quot;</span>
      </span>
      <input type="checkbox" class="class-toggle" value="1" checked />
    </label>

    <label class="legend-item">
      <span class="legend-left">
        <span class="legend-color" style="background:#fdae61;"></span>
        <span>&quot;Moderado (20-60%)&quot;</span>
      </span>
      <input type="checkbox" class="class-toggle" value="2" checked />
    </label>

    <label class="legend-item" style="margin-bottom:0;">
      <span class="legend-left">
        <span class="legend-color" style="background:#d7191c;"></span>
        <span>&quot;Grave (>60%)&quot;</span>
      </span>
      <input type="checkbox" class="class-toggle" value="3" checked />
    </label>
  </div>

  <script>
    // =========================
    // CONFIG (selector orto)
    // =========================
    const LOGO_URL = './data/geoeuskadi.png'; // <-- cambia el nombre si tu logo se llama distinto

    // Solo RGB (no IrRG). Capas geoeuskadi: ORTO_YYYY
    const ORTO_YEARS = [
      2024, 2023, 2022, 2021, 2020, 2019, 2018,
      2017, 2016, 2015, 2014, 2013, 2012, 2011,
      2010, 2009, 2008, 2007, 2006, 2005, 2004,
      2002, 2001, 1995, 1991, 1989, 1984
    ];

    const DEFAULT_YEAR = 2018;

    function wmsTileUrlForYear(year) {
      return "https://www.geo.euskadi.eus/WMS_ORTOARGAZKIAK" +
        "?service=WMS&request=GetMap&version=1.3.0" +
        "&layers=ORTO_" + year +
        "&styles=default" +
        "&format=image/png" +
        "&transparent=false" +
        "&CRS=EPSG:3857" +
        "&BBOX={bbox-epsg-3857}" +
        "&WIDTH=256&HEIGHT=256";
    }

    // =========================
    // MAPA (fondo WMS 2018 por defecto)
    // =========================
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        "version": 8,
        "sources": {
          "satellite": {
            "type": "raster",
            "tiles": [ wmsTileUrlForYear(DEFAULT_YEAR) ],
            "tileSize": 256
          }
        },
        "layers": [
          { "id": "satellite", "type": "raster", "source": "satellite" }
        ]
      },
      center: [0, 0],
      zoom: 2
    });

    // =========================
    // UI selector orto
    // =========================
    const bmBtn = document.getElementById('bmBtn');
    const bmPanel = document.getElementById('bmPanel');
    const bmOptions = document.getElementById('bmOptions');
    const bmYearLabel = document.getElementById('bmYearLabel');
    const bmLogo = document.getElementById('bmLogo');

    bmLogo.src = LOGO_URL;

    let selectedYear = DEFAULT_YEAR;
    bmYearLabel.textContent = String(selectedYear);

    function updateBasemapUI(year) {
      bmYearLabel.textContent = String(year);
      Array.from(bmOptions.querySelectorAll('.bm-option')).forEach(btn => {
        btn.classList.toggle('active', Number(btn.dataset.year) === year);
      });
    }

    function setBasemapYear(year) {
  selectedYear = year;
  updateBasemapUI(year);

  const tiles = [wmsTileUrlForYear(year)];

  const src = map.getSource('satellite');
  if (src && typeof src.setTiles === 'function') {
    src.setTiles(tiles);
    // Asegura puntos por delante
    if (map.getLayer('puntos-layer')) {
      try { map.moveLayer('puntos-layer'); } catch (_) {}
    }
    return;
  }

  // Fallback robusto: re-crear SOLO el fondo (sin tocar puntos)
  if (map.getLayer('satellite')) map.removeLayer('satellite');
  if (map.getSource('satellite')) map.removeSource('satellite');

  map.addSource('satellite', { type: 'raster', tiles, tileSize: 256 });

  // SI existen puntos, mete el WMS debajo (antes) de puntos-layer
  if (map.getLayer('puntos-layer')) {
    map.addLayer(
      { id: 'satellite', type: 'raster', source: 'satellite' },
      'puntos-layer'
    );
    // y por si acaso, fuerza puntos arriba
    try { map.moveLayer('puntos-layer'); } catch (_) {}
  } else {
    map.addLayer({ id: 'satellite', type: 'raster', source: 'satellite' });
  }
}

    function renderBasemapOptions() {
      bmOptions.innerHTML = '';
      ORTO_YEARS.forEach(y => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'bm-option' + (y === selectedYear ? ' active' : '');
        btn.textContent = String(y);
        btn.dataset.year = String(y);
        btn.addEventListener('click', () => {
          setBasemapYear(y);
          closeBasemapPanel();
        });
        bmOptions.appendChild(btn);
      });
    }

    function openBasemapPanel() {
      bmPanel.classList.add('open');
      bmBtn.setAttribute('aria-expanded', 'true');
    }
    function closeBasemapPanel() {
      bmPanel.classList.remove('open');
      bmBtn.setAttribute('aria-expanded', 'false');
    }
    function toggleBasemapPanel() {
      if (bmPanel.classList.contains('open')) closeBasemapPanel();
      else openBasemapPanel();
    }

    bmBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleBasemapPanel();
    });

    document.addEventListener('click', () => closeBasemapPanel());
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeBasemapPanel();
    });

    renderBasemapOptions();
    updateBasemapUI(DEFAULT_YEAR); // OJO: NO tocamos el mapa aquí

    // =========================
    // Tu lógica original (sin romper el load)
    // =========================
    map.on('load', async () => {
      const url = './data/muestra_wgs.geojson';

      map.addSource('puntos', {
        type: 'geojson',
        data: url
      });

      // Centrar el mapa en la extensión de la capa
      const response = await fetch(url);
      const geojson = await response.json();

      const bounds = new maplibregl.LngLatBounds();
      geojson.features.forEach(f => {
        if (f.geometry && f.geometry.type === 'Point') {
          bounds.extend(f.geometry.coordinates);
        }
      });
      map.fitBounds(bounds, { padding: 40, maxZoom: 16 });

      // Capa de puntos
      map.addLayer({
        id: 'puntos-layer',
        type: 'circle',
        source: 'puntos',
        paint: {
          'circle-radius': 6,
          'circle-opacity': 1,
          'circle-stroke-width': 0.5,
          'circle-stroke-color': '#000000',
          'circle-color': [
            'match',
            ['to-number', ['get', 'n_afeccion']],
            0, '#a6d96a',
            1, '#ffffc0',
            2, '#fdae61',
            3, '#d7191c',
            '#ff00ff'
          ]
        }
      });

      // --- Filtros por clase (checkboxes) ---
      const toggles = Array.from(document.querySelectorAll('.class-toggle'));
      const allBtn = document.getElementById('allBtn');
      const noneBtn = document.getElementById('noneBtn');

      function selectedClasses() {
        return toggles
          .filter(cb => cb.checked)
          .map(cb => Number(cb.value));
      }

      function applyClassFilter() {
        const selected = selectedClasses();

        if (selected.length === 0) {
          map.setLayoutProperty('puntos-layer', 'visibility', 'none');
          return;
        }

        map.setLayoutProperty('puntos-layer', 'visibility', 'visible');
        map.setFilter('puntos-layer', [
          'in',
          ['to-number', ['get', 'n_afeccion']],
          ['literal', selected]
        ]);
      }

      toggles.forEach(cb => cb.addEventListener('change', applyClassFilter));

      allBtn.addEventListener('click', () => {
        toggles.forEach(cb => cb.checked = true);
        applyClassFilter();
      });

      noneBtn.addEventListener('click', () => {
        toggles.forEach(cb => cb.checked = false);
        applyClassFilter();
      });

      applyClassFilter();

      // Garantiza que el fondo quede debajo
      if (map.getLayer('satellite') && map.getLayer('puntos-layer')) {
        try { map.moveLayer('satellite', 'puntos-layer'); } catch (_) {}
      }

      // Si por algún motivo ya habías seleccionado otro año antes de cargar (raro),
      // aplica el WMS elegido ahora que el mapa ya está listo.
      if (selectedYear !== DEFAULT_YEAR) {
        setBasemapYear(selectedYear);
      }
    });
  </script>
</body>
</html>
